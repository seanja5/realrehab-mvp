# Real Rehab App – Design & Logic Guide

## Product Goals

- **Patients**: Complete prescribed rehab exercises with sensor (BLE) feedback; see journey map and lesson progression; link to a PT via access code; manage profile and settings; set personalized weekly schedule with optional reminders (T-15 and T); view "My Schedule" visualizer and progress charts.
- **PTs**: Manage patient list; assign and customize rehab plans (category/injury, lesson nodes with reps/rest); view/edit patient notes; manage own profile.
- **Data**: Auth and all app data in Supabase; RLS and RPCs for security; caching for performance; telemetry (sessions, calibration) for progress; patient_schedule_slots and schedule_reminders_enabled for scheduling; pt_profiles.notify_session_complete / notify_missed_day and pt_session_complete_events for PT "patient session completed" notifications; deep link and PendingLinkStore for invite/link flow.

---

## App Overview

**Real Rehab** is a rehabilitation assistant that connects patients with physical therapists. Two user flows:

- **Patient**: Onboarding (Welcome → Login or Get Started → CreateAccount with account type) → Tab bar (Dashboard, Journey, Settings, Add). CreateAccount: unified form with Patient/PT type selector; patient goes to ptDetail; PT goes to patientList. Pairing/calibration: accessed via Add button (pairDevice → calibrateDevice → allSet → ptDetail). Dashboard (PTDetailView): PT info, rehab plan, "My Schedule" visualizer, Create/Edit Schedule, RecoveryChartWeekView, ActivityConsistencyCard. Lesson flow: Directions → Lesson → Assessment(lessonId) → Completion(lessonId). CompletionView calls PatientService.notifyPTSessionComplete when lessonId present (RPC inserts into pt_session_complete_events if PT has notify_session_complete enabled). Settings: profile, Allow reminders toggle, link to PT via access code, sign out.
- **PT**: Same WelcomeView; Get Started → CreateAccount (PT type) or Login → Patient List → Patient Detail (notes, rehab plan, RecoveryChartWeekView, ActivityConsistencyCard) → Category/Injury select → PT Journey Map (edit nodes, save plan). Tab: PT Settings.

**Backend**: Supabase (auth, `accounts` schema: profiles, patient_profiles, pt_profiles, pt_patient_map, rehab_plans, patient_schedule_slots, pt_session_complete_events; `rehab` schema: assignments, programs, lessons). **Cache**: `CacheService` (memory + optional disk, TTLs). **BLE**: `BluetoothManager` for sensor pairing/calibration; telemetry saved via `TelemetryService`. **Schedule**: `ScheduleService` for patient_schedule_slots; `NotificationManager` for schedule reminders (T-15, T) and PT session-complete notifications; `patient_profiles.schedule_reminders_enabled`. **Linking/invite**: Deep link `realrehab://link?code=...` and optional https `/link?code=...` (Universal Links); `PendingLinkStore` for pre-fill on CreateAccount/PatientSettings; share via `ShareSheetHelper` (ShareImage, message, URL).

---

## Routing (`AppRouter.swift`)

**Route enum**:
- Patient: `welcome`, `createAccount`, `pairDevice`, `calibrateDevice`, `allSet`, `ptDetail`, `home`, `homeSubCategory`, `rehabOverview`, `journeyMap`, `patientSettings`, `directionsView1(reps,restSec,lessonId)`, `directionsView2`, `lesson(reps,restSec,lessonId)`, `assessment(lessonId)`, `completion(lessonId)`.
- PT: `ptCreateAccount`, `ptSettings`, `patientList`, `ptPatientDetail(patientProfileId)`, `ptCategorySelect(patientProfileId)`, `ptInjurySelect(patientProfileId)`, `ptJourneyMap(patientProfileId, planId)`.

**Tab bar routes** (Router): `ptDetail`, `journeyMap`, `patientSettings`, `ptSettings`, `patientList`.

**Router**: `Router` is `ObservableObject` with `path: NavigationPath`. Use `router.go(_:)`, `router.reset(to:)`, `router.goWithoutAnimation(_:)` for tab-style jumps.

---

## Key Services

- **SupabaseService**: Shared `SupabaseClient`; `SupabaseConfig.plist` for URL/key.
- **AuthService**: `signUp`, `signIn`, `signOut`, `currentUserId`, `myProfile`, `myProfileIdAndRole`, `resolveIdsForCurrentUser`; uses `accounts.profiles`.
- **PatientService**: Patient profile CRUD, `myPatientProfileId`, `hasPT`, `getPTProfileId`, `linkPatientToPT`, `linkPatientViaAccessCode`, `findPatientByAccessCode`, `getScheduleRemindersEnabled`, `setScheduleRemindersEnabled`, `notifyPTSessionComplete(patientProfileId, lessonId, lessonTitle)` (RPC when patient reaches Completion screen); uses RPCs and `accounts` tables; caches via CacheService.
- **PTService**: `ensurePTProfile`, `myPTProfile`, `myPTProfileForDisplay`, `updateNotificationPreferences(ptProfileId, notifySessionComplete, notifyMissedDay)`, `fetchRecentSessionCompleteEvents`, `listMyPatients`, `getPatient`, `addPatient` (RPC `add_patient_with_mapping`), `deletePatientMapping`, `updatePTProfile`; uses `accounts.pt_profiles` (including `notify_session_complete`, `notify_missed_day`), `accounts.pt_session_complete_events`; caches.
- **RehabService**: `myActiveAssignment`, `lessons(for:)`, `program(id:)`, `currentPlan`, `saveACLPlan`, `fetchPlan`, `updatePlanNotes`; uses `rehab.assignments`, `rehab.lessons`, `rehab.programs`, `accounts.rehab_plans`; caches plans/lessons/program. Uses `executeAsync()` (AuthService extension) for non-decoding writes.
- **ScheduleService**: `getSchedule(patientProfileId)`, `saveSchedule(patientProfileId, slots)`, `timeString(from:)`, `slotsFrom(selectedDays:times:)`; uses `accounts.patient_schedule_slots`; caches via `CacheKey.patientSchedule`; 30-min blocks, 15-min granularity.
- **NotificationManager**: `requestAuthorizationIfNeeded`, `authorizationStatus`, `scheduleScheduleReminders(slots:firstName:)`, `cancelScheduleReminders`, `showSessionCompleteNotification(patientName:lessonName:patientProfileId)` (PT: "X just completed Y, tap to view insights"); categories `SCHEDULE_REMINDER`, `PT_SESSION_COMPLETE`; deep link to journeyMap or ptPatientDetail via `userInfo`.
- **ShareSheetHelper**: `activityItems(for: code)` (ShareImage from Assets, message, https URL for rich preview), `presentShareSheet(code:...)`; share link base URL configurable for Open Graph when site exists.
- **PTSessionCompleteNotifier**: When PT app becomes active, fetches `PTService.fetchRecentSessionCompleteEvents`, shows local notification for each new event (tracks notified IDs in UserDefaults); tap opens patient detail.
- **TelemetryService**: Sessions, calibration (save/fetch), device assignment (RPC `get_or_create_device_assignment`); uses Supabase auth + PatientService for profile.
- **LessonEngine**: In-memory lesson state (phase, reps, fill, validation); used by LessonView/AssessmentView.
- **CacheService** (`@MainActor`): `getCached`/`setCached` (async, TTL), `invalidate`/`invalidateMatching`; keys via `CacheKey`; memory-first, optional disk.
- **BluetoothManager**: BLE scan, connect, flex sensor value; used by PairDeviceView, CalibrateDeviceView, LessonView, AssessmentView.

**When adding features**: Use the service that owns the domain (auth → AuthService, patient profile/linking → PatientService, PT/patients → PTService, plans/lessons → RehabService, schedule → ScheduleService, reminders → NotificationManager, sensor/calibration → TelemetryService). For Supabase writes that don't decode a body, use `.executeAsync()` (AuthService extension). RPCs exist for device assignment, link patient, add patient with mapping; add new RPCs in Supabase and call from the appropriate service. Cache: use `CacheKey` enum for key names; call `invalidate`/`setCached` after writes so UI stays consistent.

---

## Session & State

- **SessionContext**: `@Published profileId: UUID?`, `@Published ptProfileId: UUID?`. Set after auth (e.g. from `AuthService.resolveIdsForCurrentUser`). Injected as `@EnvironmentObject`; views use it to know "current user's profile" and "current PT" for API calls and tab state.
- **ViewModels**: `AuthViewModel`, `PatientDashboardViewModel`, `PatientPTViewModel`, `LessonSessionViewModel`, `JourneyMapViewModel`, `PTPatientsViewModel`, `PTProgramEditorViewModel`; typically `@MainActor`, load from services and drive views.
- **Stores**: `PendingLinkStore` (code from deep link for pre-fill); `InvitedPatientsStore` (optional; invite button visibility is driven by link status, not this store).

**View → Service/ViewModel (for adding features)**:
- Patient: WelcomeView/CreateAccount → AuthViewModel, AuthService. PairDeviceView/CalibrateDeviceView → BluetoothManager, TelemetryService. PTDetailView → PatientPTViewModel (RehabService.currentPlan, PTService.getPTInfo, ScheduleService.getSchedule). RehabOverviewView → ScheduleService, PatientService (setScheduleRemindersEnabled), NotificationManager. JourneyMapView → JourneyMapViewModel (RehabService.currentPlan, fetchPlan). Lesson flow → LessonSessionViewModel, LessonEngine, TelemetryService, BluetoothManager. PatientSettingsView → PatientService, AuthService (link PT, profile, getScheduleRemindersEnabled/setScheduleRemindersEnabled, sign out), ScheduleService, NotificationManager.
- PT: PatientListView → PTPatientsViewModel (PTService.listMyPatients, session.ptProfileId); PatientCard shows Invite when !isLinked. PatientDetailView → PTService.getPatient, RehabService (currentPlan, updatePlanNotes), ShareSheetHelper for Invite Patient. PTJourneyMapView → RehabService (fetchPlan, saveACLPlan). PTSettingsView → PTService.myPTProfile, myPTProfileForDisplay, updateNotificationPreferences (notify toggles). RealRehabPracticeApp → checkPTSessionCompleteIfNeeded (PT only), PTSessionCompleteNotifier.checkAndNotify.

---

## Views (Concise)

**Patient onboarding**: WelcomeView (Login / Get Started) → CreateAccountView (account type: Patient or PT; patient fields: DOB, gender, access code, etc.; PT fields: license, NPI, etc.). Patient → ptDetail; PT → patientList. Pairing (optional): Add button → PairDeviceView (BLE scan, pair) → CalibrateDeviceView or TestCalibrationView (starting/max position) → AllSetView → ptDetail.

**Patient main**: PTDetailView (Dashboard tab): PT info, current rehab plan, "My Schedule" (ScheduleVisualizerView), Create/Edit Schedule → RehabOverviewView, RecoveryChartWeekView, ActivityConsistencyCard. RehabOverviewView: days/times (up to 2 per day), Allow Reminders toggle, Confirm Schedule → saves to ScheduleService, PatientService.setScheduleRemindersEnabled, NotificationManager. Lesson flow: DirectionsView1/2 → LessonView (LessonEngine, BLE flex value) → AssessmentView(lessonId) → CompletionView(lessonId). CompletionView notifies PT via PatientService.notifyPTSessionComplete when lessonId present (if PT has notify_session_complete on). PatientSettingsView: profile, Allow reminders toggle (synced with schedule_reminders_enabled), Allow camera, link PT (access code), sign out.

**PT flow**: WelcomeView → CreateAccountView (PT type) or login → PatientListView (PTService.listMyPatients). Patient list cards: show "Invite" only when patient is not linked (profile_id == nil); Invite opens share sheet (ShareSheetHelper); button stays until patient actually links. PatientDetailView: demographics, notes (saved to plan), RecoveryChartWeekView, ActivityConsistencyCard, access code section with "Invite Patient" button (shown only when patient not linked), "Select Rehab Plan" → CategorySelectView → InjurySelectView → PTJourneyMapView (nodes editable, save to RehabService.saveACLPlan). PTSettingsView: Account → Practice → Notifications (Patient session completed, Missed day reminders toggles; only session complete is implemented) → Sign out; toggles persisted to pt_profiles via PTService.updateNotificationPreferences. When PT app becomes active, PTSessionCompleteNotifier fetches new pt_session_complete_events and shows local notification; tap → Patient Detail.

**Shared UI**: Theme (`.rrHeadline`, `.rrTitle`, `.rrBody`, `.rrCallout`, `.rrCaption`; brand colors; RRSpace). Components: PrimaryButton, SecondaryButton, BackButton, FormTextField, FormSecureField, FormDateField, FormMenuField, StepIndicator, BodyPartCard, NodeView, PTNodeView, BluetoothStatusIndicator, bluetoothPopupOverlay, ScheduleVisualizerView, RecoveryChartWeekView, ActivityConsistencyCard, PatientTabBar (Dashboard, Journey, Settings, Add). All screens use `.rrPageBackground()`; toolbar back via `BackButton()` except WelcomeView.

---

## Data Models (Key)

- **Profiles**: AuthService `Profile` (id, user_id, role, email, first_name, last_name, phone). PatientService `PatientProfileRow`; PTService `PTProfileRow`, `SimplePatient`. RehabService: `AssignmentRow`, `ProgramRow`, `Lesson`, `PlanRow`, `LessonNode` (id, title, icon, isLocked, reps, restSec); plan nodes stored as JSON in `rehab_plans.nodes`.
- **rehab_plans** (Supabase): id, pt_profile_id, patient_profile_id, category, injury, status (e.g. active/archived), created_at, nodes (JSON array), notes. One active plan per patient; save via RehabService.saveACLPlan/updatePlanNotes.
- **patient_schedule_slots** (Supabase): id, patient_profile_id, day_of_week (0–6), slot_time ("HH:mm:ss"); 30-min blocks; ScheduleService get/save.
- **patient_profiles.schedule_reminders_enabled**: Boolean; PatientService.getScheduleRemindersEnabled/setScheduleRemindersEnabled.
- **Linking**: pt_patient_map links patient_profile_id ↔ pt_profile_id. Patients link via access code (PatientService.linkPatientViaAccessCode, RPCs); PT adds patients via PTService.addPatient (RPC add_patient_with_mapping). Deep link realrehab://link?code=... or https .../link?code=... opens app; PendingLinkStore holds code for CreateAccount/PatientSettings pre-fill. Invite: ShareSheetHelper shares ShareImage, message, and URL; Invite button only when patient not linked (profile_id == nil).
- **PT notifications**: pt_profiles.notify_session_complete (default true), notify_missed_day (default false); pt_session_complete_events (id, pt_profile_id, patient_profile_id, patient name, lesson_id, lesson_title, created_at). RPC notify_pt_session_complete(p_patient_profile_id, p_lesson_id, p_lesson_title) called by patient app from CompletionView; inserts event only if PT has notify_session_complete = true. PT app on active fetches new events and shows local notification; tap opens patient detail. Migration: `supabase/migrations/20260211000000_pt_session_complete_notifications.sql`.
- **Scheduling**: `SchedulingModels.swift` – Weekday, DayTime; ScheduleService.ScheduleSlot (day_of_week, slot_time); schedule preferences used in RehabOverviewView, ScheduleVisualizerView, NotificationManager.
- **Cache keys**: `CacheKey` enum (e.g. patientProfile, rehabPlan, patientList, authProfile, patientSchedule, scheduleRemindersEnabled); use for getCached/setCached/invalidate so keys stay consistent.

---

## Style & Conventions

- **Typography**: Use Theme.swift only (`.rrHeadline`, `.rrTitle`, `.rrBody`, `.rrCallout`, `.rrCaption`); no raw `.font(.system(...))`.
- **Colors**: `Color.brandDarkBlue`, `Color.brandLightBlue`; page background via `.rrPageBackground()`.
- **Spacing**: `RRSpace.pageTop`, `RRSpace.section`, `RRSpace.stack`; horizontal padding 16–20pt.
- **Navigation**: Inline title; `BackButton()` in toolbar (except WelcomeView). PrimaryButton / SecondaryButton for actions; disable with `isDisabled` where needed.
- **Layout**: ScrollView for long content; bottom buttons via `.safeAreaInset(edge: .bottom)`; sticky headers via `.safeAreaInset(edge: .top)`.

---

## Xcode Project Rules (`.cursorrules`)

When adding **new Swift or resource files** under `RealRehabPractice/`, **update** `RealRehabPractice.xcodeproj/project.pbxproj`: add PBXFileReference, PBXBuildFile, correct PBXGroup (see .cursorrules for group IDs), and Sources or Resources build phase so new files appear in Xcode and in the build.

---

## Update Rule

When adding a screen or feature:
1. Add route in `AppRouter.swift` and destination in app entry.
2. Document in this file: purpose, key actions, connected screens, data/services used.
3. Use Theme + `.rrPageBackground()` + BackButton where appropriate.
4. If persisting data: use Supabase (via existing services) or document any new keys/cache.

---

## Key Files

- **Router**: `RealRehabPractice/App/AppRouter.swift`
- **App entry**: `RealRehabPractice/App/RealRehabPracticeApp.swift` (NotificationDelegate, onOpenURL for realrehab:// and https /link?code= → PendingLinkStore; rescheduleRemindersIfNeeded, checkPTSessionCompleteIfNeeded on scenePhase; scheduleReminderTapped → journeyMap, ptSessionCompleteTapped → ptPatientDetail(patientProfileId))
- **NotificationDelegate**: `RealRehabPractice/App/NotificationDelegate.swift` (schedule reminder tap → journeyMap; PT session complete tap → ptPatientDetail)
- **Theme**: `RealRehabPractice/Components/Theme.swift`
- **Components**: `RealRehabPractice/Components/Components.swift`, `PatientTabBar.swift`, `ScheduleVisualizerView.swift`
- **Models**: `RealRehabPractice/Models/SchedulingModels.swift`, `SessionContext.swift`
- **Services**: `RealRehabPractice/Services/` (Auth, Patient, PT, Rehab, Schedule, NotificationManager, PTSessionCompleteNotifier, Telemetry, Supabase, Cache, BLE, LessonEngine); `RealRehabPractice/Utilities/ShareSheetHelper.swift`
- **Xcode project**: `RealRehabPractice/RealRehabPractice.xcodeproj/project.pbxproj` (edit when adding files)

---

## MCP / Build

**XcodeBuildMCP** is available for building and running the app. Prefer it for build verification. Session defaults: set `projectPath`, `scheme` (RealRehabPractice), and for simulator `simulatorName` (e.g. iPhone 17).

---

*Last updated: February 2026 – PT invite/share: ShareSheetHelper (ShareImage, message, URL), Invite Patient on list card and detail (only when patient not linked), deep link realrehab:// and https /link, PendingLinkStore. PT notifications: pt_profiles.notify_session_complete/notify_missed_day, pt_session_complete_events, RPC notify_pt_session_complete, CompletionView triggers notify, PTSessionCompleteNotifier + local notification, tap → patient detail. Routes: assessment(lessonId), completion(lessonId). PTSettings: Account → Practice → Notifications → Sign out; toggles persisted. ScheduleService, NotificationManager, patient_schedule_slots, schedule_reminders_enabled, PatientTabBar, ScheduleVisualizerView, RecoveryChartWeekView, ActivityConsistencyCard, unified CreateAccountView, BluetoothStatusIndicator, bluetoothPopupOverlay.*

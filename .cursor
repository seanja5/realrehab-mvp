# Real Rehab App – Design & Logic Guide

## Product Goals

- **Patients**: Complete prescribed rehab exercises with sensor (BLE) feedback; see journey map and lesson progression; link to a PT via access code; manage profile and settings.
- **PTs**: Manage patient list; assign and customize rehab plans (category/injury, lesson nodes with reps/rest); view/edit patient notes; manage own profile.
- **Data**: Auth and all app data in Supabase; RLS and RPCs for security; caching for performance; telemetry (sessions, calibration) for progress.

---

## App Overview

**Real Rehab** is a rehabilitation assistant that connects patients with physical therapists. Two user flows:

- **Patient**: Onboarding (Welcome → CreateAccount or SelectSignUp → PairDevice → CalibrateDevice → AllSet) → Tab bar (PT Detail, Journey Map, Settings). From PT Detail: view PT info, rehab plan; tap plan → Journey Map → Lessons (Directions → Lesson → Assessment → Completion). Settings: profile, link to PT via access code, sign out.
- **PT**: SelectSignUp → PTCreateAccount or sign in → Patient List → Patient Detail (notes, rehab plan) → Category/Injury select → PT Journey Map (edit nodes, save plan). Tab: PT Settings.

**Backend**: Supabase (auth, `accounts` schema: profiles, patient_profiles, pt_profiles, pt_patient_map, rehab_plans; `rehab` schema: assignments, programs, lessons). **Cache**: `CacheService` (memory + optional disk, TTLs). **BLE**: `BluetoothManager` for sensor pairing/calibration; telemetry saved via `TelemetryService`.

---

## Routing (`AppRouter.swift`)

**Route enum** (simplified):
- Patient: `welcome`, `selectSignUp`, `createAccount`, `pairDevice`, `calibrateDevice`, `allSet`, `ptDetail`, `home`, `homeSubCategory`, `rehabOverview`, `journeyMap`, `patientSettings`, `directionsView1(reps,restSec)`, `directionsView2`, `lesson(reps,restSec)`, `assessment`, `completion`.
- PT: `ptCreateAccount`, `ptSettings`, `patientList`, `ptPatientDetail(patientProfileId)`, `ptCategorySelect(patientProfileId)`, `ptInjurySelect(patientProfileId)`, `ptJourneyMap(patientProfileId, planId)`.

**Tab bar routes** (Router): `ptDetail`, `journeyMap`, `patientSettings`, `ptSettings`, `patientList`.

**Router**: `Router` is `ObservableObject` with `path: NavigationPath`. Use `router.go(_:)`, `router.reset(to:)`, `router.goWithoutAnimation(_:)` for tab-style jumps.

---

## Key Services

- **SupabaseService**: Shared `SupabaseClient`; `SupabaseConfig.plist` for URL/key.
- **AuthService**: `signUp`, `signIn`, `signOut`, `currentUserId`, `myProfile`, `myProfileIdAndRole`, `resolveIdsForCurrentUser`; uses `accounts.profiles`.
- **PatientService**: Patient profile CRUD, `myPatientProfileId`, `hasPT`, `getPTProfileId`, `linkPatientToPT`, `linkPatientViaAccessCode`, `findPatientByAccessCode`; uses RPCs and `accounts` tables; caches via CacheService.
- **PTService**: `ensurePTProfile`, `myPTProfile`, `listMyPatients`, `getPatient`, `addPatient` (RPC `add_patient_with_mapping`), `deletePatientMapping`, `updatePTProfile`; uses `accounts`; caches.
- **RehabService**: `myActiveAssignment`, `lessons(for:)`, `program(id:)`, `currentPlan`, `saveACLPlan`, `fetchPlan`, `updatePlanNotes`; uses `rehab.assignments`, `rehab.lessons`, `rehab.programs`, `accounts.rehab_plans`; caches plans/lessons/program. Uses `executeAsync()` (AuthService extension) for non-decoding writes.
- **TelemetryService**: Sessions, calibration (save/fetch), device assignment (RPC `get_or_create_device_assignment`); uses Supabase auth + PatientService for profile.
- **LessonEngine**: In-memory lesson state (phase, reps, fill, validation); used by LessonView/AssessmentView.
- **CacheService** (`@MainActor`): `getCached`/`setCached` (async, TTL), `invalidate`/`invalidateMatching`; keys via `CacheKey`; memory-first, optional disk.
- **BluetoothManager**: BLE scan, connect, flex sensor value; used by PairDeviceView, CalibrateDeviceView, LessonView, AssessmentView.

**When adding features**: Use the service that owns the domain (auth → AuthService, patient profile/linking → PatientService, PT/patients → PTService, plans/lessons → RehabService, sensor/calibration → TelemetryService). For Supabase writes that don’t decode a body, use `.executeAsync()` (AuthService extension). RPCs exist for device assignment, link patient, add patient with mapping; add new RPCs in Supabase and call from the appropriate service. Cache: use `CacheKey` enum for key names; call `invalidate`/`setCached` after writes so UI stays consistent.

---

## Session & State

- **SessionContext**: `@Published profileId: UUID?`, `@Published ptProfileId: UUID?`. Set after auth (e.g. from `AuthService.resolveIdsForCurrentUser`). Injected as `@EnvironmentObject`; views use it to know “current user’s profile” and “current PT” for API calls and tab state.
- **ViewModels**: `AuthViewModel`, `PatientDashboardViewModel`, `PatientPTViewModel`, `LessonSessionViewModel`, `JourneyMapViewModel`, `PTPatientsViewModel`, `PTProgramEditorViewModel`; typically `@MainActor`, load from services and drive views.

**View → Service/ViewModel (for adding features)**:
- Patient: WelcomeView/CreateAccount → AuthViewModel, AuthService. PairDeviceView/CalibrateDeviceView → BluetoothManager, TelemetryService. PTDetailView → PatientPTViewModel (RehabService.currentPlan, PTService.getPTInfo). JourneyMapView → JourneyMapViewModel (RehabService.currentPlan, fetchPlan). Lesson flow → LessonSessionViewModel, LessonEngine, TelemetryService, BluetoothManager. PatientSettingsView → PatientService, AuthService (link PT, profile, sign out).
- PT: PatientListView → PTPatientsViewModel (PTService.listMyPatients, session.ptProfileId). PatientDetailView → PTService.getPatient, RehabService (currentPlan, updatePlanNotes). PTJourneyMapView → RehabService (fetchPlan, saveACLPlan). PTSettingsView → PTService.myPTProfile, AuthService.

---

## Views (Concise)

**Patient onboarding**: WelcomeView (Get Started / Log In) → CreateAccount or SelectSignUp → CreateAccount (email, password, DOB, gender, access code, etc.) or PTCreateAccount (PT sign up). Then PairDeviceView (BLE scan, pair) → CalibrateDeviceView or TestCalibrationView (starting/max position) → AllSetView → PTDetailView (tab).

**Patient main**: PTDetailView shows PT info and current rehab plan; tap plan → JourneyMapView (nodes from RehabService, unlock by order). Lesson flow: DirectionsView1/2 → LessonView (LessonEngine, BLE flex value) → AssessmentView → CompletionView (range gained, etc.). PatientSettingsView: profile, link PT (access code), sign out.

**PT flow**: SelectSignUpView → PTCreateAccountView or login → PatientListView (PTService.listMyPatients). PatientDetailView: demographics, notes (saved to plan), “Select Rehab Plan” → CategorySelectView → InjurySelectView → PTJourneyMapView (nodes editable, save to RehabService.saveACLPlan). PTSettingsView: profile, sign out.

**Shared UI**: Theme (`.rrHeadline`, `.rrTitle`, `.rrBody`, `.rrCallout`, `.rrCaption`; brand colors; RRSpace). Components: PrimaryButton, SecondaryButton, BackButton, FormTextField, FormSecureField, FormDateField, FormMenuField, StepIndicator, BodyPartCard, NodeView, PTNodeView, etc. All screens use `.rrPageBackground()`; toolbar back via `BackButton()` except WelcomeView.

---

## Data Models (Key)

- **Profiles**: AuthService `Profile` (id, user_id, role, email, first_name, last_name, phone). PatientService `PatientProfileRow`; PTService `PTProfileRow`, `SimplePatient`. RehabService: `AssignmentRow`, `ProgramRow`, `Lesson`, `PlanRow`, `LessonNode` (id, title, icon, isLocked, reps, restSec); plan nodes stored as JSON in `rehab_plans.nodes`.
- **rehab_plans** (Supabase): id, pt_profile_id, patient_profile_id, category, injury, status (e.g. active/archived), created_at, nodes (JSON array), notes. One active plan per patient; save via RehabService.saveACLPlan/updatePlanNotes.
- **Linking**: pt_patient_map links patient_profile_id ↔ pt_profile_id. Patients link via access code (PatientService.linkPatientViaAccessCode, RPCs); PT adds patients via PTService.addPatient (RPC add_patient_with_mapping).
- **Scheduling**: `SchedulingModels.swift` – Weekday, DayTime; schedule preferences (start date, days, times) used in RehabOverviewView and journey/summary UI.
- **Cache keys**: `CacheKey` enum (e.g. patientProfile, rehabPlan, patientList, authProfile); use for getCached/setCached/invalidate so keys stay consistent.

---

## Style & Conventions

- **Typography**: Use Theme.swift only (`.rrHeadline`, `.rrTitle`, `.rrBody`, `.rrCallout`, `.rrCaption`); no raw `.font(.system(...))`.
- **Colors**: `Color.brandDarkBlue`, `Color.brandLightBlue`; page background via `.rrPageBackground()`.
- **Spacing**: `RRSpace.pageTop`, `RRSpace.section`, `RRSpace.stack`; horizontal padding 16–20pt.
- **Navigation**: Inline title; `BackButton()` in toolbar (except WelcomeView). PrimaryButton / SecondaryButton for actions; disable with `isDisabled` where needed.
- **Layout**: ScrollView for long content; bottom buttons via `.safeAreaInset(edge: .bottom)`; sticky headers via `.safeAreaInset(edge: .top)`.

---

## Xcode Project Rules (`.cursorrules`)

When adding **new Swift or resource files** under `RealRehabPractice/`, **update** `RealRehabPractice.xcodeproj/project.pbxproj`: add PBXFileReference, PBXBuildFile, correct PBXGroup (see .cursorrules for group IDs), and Sources or Resources build phase so new files appear in Xcode and in the build.

---

## Update Rule

When adding a screen or feature:
1. Add route in `AppRouter.swift` and destination in app entry.
2. Document in this file: purpose, key actions, connected screens, data/services used.
3. Use Theme + `.rrPageBackground()` + BackButton where appropriate.
4. If persisting data: use Supabase (via existing services) or document any new keys/cache.

---

## Key Files

- **Router**: `RealRehabPractice/App/AppRouter.swift`
- **App entry**: `RealRehabPractice/App/RealRehabPracticeApp.swift`
- **Theme**: `RealRehabPractice/Components/Theme.swift`
- **Components**: `RealRehabPractice/Components/Components.swift`
- **Models**: `RealRehabPractice/Models/SchedulingModels.swift`, `SessionContext.swift`
- **Services**: `RealRehabPractice/Services/` (Auth, Patient, PT, Rehab, Telemetry, Supabase, Cache, BLE, LessonEngine)
- **Xcode project**: `RealRehabPractice/RealRehabPractice.xcodeproj/project.pbxproj` (edit when adding files)

---

## MCP / Build

**XcodeBuildMCP** is available for building and running the app. Prefer it for build verification. Session defaults: set `projectPath`, `scheme` (RealRehabPractice), and for simulator `simulatorName` (e.g. iPhone 16).

---

*Last updated: January 2025 – Supabase backend, BLE, cache, SessionContext, current routes and services.*
